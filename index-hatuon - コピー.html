<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pronunciation Practice App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            color: #374151; /* Tailwind gray-700 */
            padding: 1rem;
            text-align: center;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 700px;
            margin-top: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            cursor: pointer;
            border: none;
            outline: none;
            margin: 0.5rem;
        }
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .btn:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); /* Tailwind blue-300 focus ring */
        }
        .btn-primary { background-color: #3b82f6; color: white; } /* blue-500 */
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; } /* blue-600 */
        .btn-secondary { background-color: #6b7280; color: white; } /* gray-500 */
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; } /* gray-600 */
        .btn-success { background-color: #10b981; color: white; } /* green-500 */
        .btn-success:hover:not(:disabled) { background-color: #059669; } /* green-600 */
        .btn-danger { background-color: #ef4444; color: white; } /* red-500 */
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; } /* red-600 */
        .btn-warning { background-color: #f59e0b; color: white; } /* amber-500 */
        .btn-warning:hover:not(:disabled) { background-color: #d97706; } /* amber-600 */
        .btn-info { background-color: #38bdf8; color: white; } /* sky-400 */
        .btn-info:hover:not(:disabled) { background-color: #0ea5e9; } /* sky-500 */

        .sentence-display { font-size: 1.5rem; font-weight: 500; margin-bottom: 1.5rem; padding: 1rem; background-color: #e5e7eb; border-radius: 0.5rem; min-height: 100px; display: flex; align-items: center; justify-content: center; color: #1f2937; }
        .recognized-text-display { font-size: 1.125rem; margin-top: 1rem; padding: 0.75rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; min-height: 60px; color: #4b5563; }
        .feedback-display { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; min-height: 40px; }
        .feedback-correct { color: #10b981; } /* green-500 */
        .feedback-incorrect { color: #ef4444; } /* red-500 */
        .status-message { margin-top: 1rem; color: #6b7280; min-height: 24px; }
        .footer-note { margin-top: 2rem; font-size: 0.875rem; color: #6b7280; }

        .teacher-mode-container { border-top: 2px solid #3b82f6; margin-top: 2rem; padding-top: 1.5rem; }
        .sentence-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; background-color: #f9fafb; }
        .sentence-text { flex-grow: 1; text-align: left; margin-right: 1rem; color: #374151;}
        .sentence-actions button { margin-left: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; }
        .add-sentence-form textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; min-height: 80px; margin-bottom: 0.5rem; color: #374151;}
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.5rem; text-align: left; color: #374151;}
        .modal-content textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; min-height: 100px; margin-bottom: 1rem; color: #374151;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-body { margin-bottom: 1.5rem; }
        .modal-footer { text-align: right; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; background: none; border: none; padding: 0; line-height: 1;}
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; }
        
        .audio-player-container { margin-top: 1rem; }
        audio::-webkit-media-controls-panel { background-color: #e5e7eb; }
        audio::-webkit-media-controls-play-button { background-color: #3b82f6; border-radius: 50%; }
        audio::-webkit-media-controls-current-time-display, 
        audio::-webkit-media-controls-time-remaining-display { color: #1f2937; }
    </style>
</head>
<body>
    <div class="w-full max-w-md mx-auto my-4">
        <button id="toggle-mode-btn" class="btn btn-primary w-full">Switch to Teacher Mode</button>
    </div>

    <div class="container" id="student-mode-container">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">English Pronunciation Practice</h1>
        <div id="sentence-display" class="sentence-display">Loading sentence...</div>
        <div class="flex flex-wrap justify-center items-center mb-4">
            <button id="speak-btn" class="btn btn-primary">Speak Example</button>
            <button id="record-btn" class="btn btn-success">Record Pronunciation</button>
            <button id="play-recorded-audio-btn" class="btn btn-info" disabled>Play My Recording</button>
        </div>
        <div id="status-message" class="status-message">Ready</div>
        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">You Pronounced (Text):</h2>
            <div id="recognized-text" class="recognized-text-display"></div>
        </div>
        <div id="result-feedback" class="feedback-display"></div>
        <div class="audio-player-container">
            <audio id="recorded-audio-player" controls class="w-full hidden"></audio>
        </div>
        <div class="mt-6 text-center">
            <button id="next-btn" class="btn btn-secondary">Next Example</button>
        </div>
    </div>

    <div class="container teacher-mode-container hidden" id="teacher-mode-container">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">Manage Sentences</h1>
        <div class="add-sentence-form mb-6">
            <h2 class="text-xl font-semibold mb-2 text-left">Add New Sentence</h2>
            <textarea id="new-sentence-text" placeholder="Enter new sentence here..."></textarea>
            <button id="add-sentence-btn" class="btn btn-success w-full">Add Sentence</button>
        </div>
        <div>
            <h2 class="text-xl font-semibold mb-2 text-left">Registered Sentences List</h2>
            <div id="sentence-list" class="space-y-2">
                </div>
            <p id="no-sentences-message" class="text-gray-500 mt-4 hidden">No sentences registered yet.</p>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Sentence</h2>
                <span class="close-btn" id="close-edit-modal-btn">&times;</span>
            </div>
            <div class="modal-body">
                <textarea id="edit-sentence-input"></textarea>
            </div>
            <div class="modal-footer">
                <button id="save-edit-btn" class="btn btn-primary">Save Changes</button>
                 <button id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="custom-alert-title" class="modal-title">Alert</h2>
                 <button id="close-alert-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p id="custom-alert-message"></p>
            </div>
            <div class="modal-footer">
                <button id="custom-alert-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h2 id="custom-confirm-title" class="modal-title">Confirm</h2>
                <button id="close-confirm-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p id="custom-confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button id="custom-confirm-yes-btn" class="btn btn-danger">Yes</button>
                <button id="custom-confirm-no-btn" class="btn btn-secondary">No</button>
            </div>
        </div>
    </div>

    <p class="footer-note">
        This app uses the browser's Web Speech API. For the best experience, please use the latest version of Google Chrome. Microphone permission is required.
    </p>

    <script>
        const defaultSentences = [
            "Today is a sunny day. I enjoy learning new things.",
            "My favorite season is spring. Many flowers bloom in spring.",
            "I will go to the library tomorrow. I want to borrow some interesting books."
        ];
        let sentences = [];

        let currentSentenceIndex = 0;
        let speechRecognition;
        let synthesis = window.speechSynthesis;
        let englishVoice = null;
        let micPermissionGranted = false;
        let currentMode = 'student'; // 'student' or 'teacher'
        let editingSentenceIndex = -1;

        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob = null;
        let isRecording = false; // Tracks MediaRecorder and SpeechRecognition state

        // DOM Elements
        const sentenceDisplay = document.getElementById('sentence-display');
        const speakButton = document.getElementById('speak-btn');
        const recordButton = document.getElementById('record-btn');
        const playRecordedAudioButton = document.getElementById('play-recorded-audio-btn');
        const recordedAudioPlayer = document.getElementById('recorded-audio-player');
        const recognizedTextDisplay = document.getElementById('recognized-text');
        const resultFeedback = document.getElementById('result-feedback');
        const nextButton = document.getElementById('next-btn');
        const statusMessage = document.getElementById('status-message');

        const toggleModeButton = document.getElementById('toggle-mode-btn');
        const studentModeContainer = document.getElementById('student-mode-container');
        const teacherModeContainer = document.getElementById('teacher-mode-container');
        const newSentenceText = document.getElementById('new-sentence-text');
        const addSentenceButton = document.getElementById('add-sentence-btn');
        const sentenceList = document.getElementById('sentence-list');
        const noSentencesMessage = document.getElementById('no-sentences-message');

        const editModal = document.getElementById('edit-modal');
        const closeEditModalButton = document.getElementById('close-edit-modal-btn');
        const editSentenceInput = document.getElementById('edit-sentence-input');
        const saveEditButton = document.getElementById('save-edit-btn');
        const cancelEditButton = document.getElementById('cancel-edit-btn');

        // Custom Modal Elements
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkButton = document.getElementById('custom-alert-ok-btn');
        const closeAlertModalButton = document.getElementById('close-alert-modal-btn');

        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const customConfirmTitle = document.getElementById('custom-confirm-title');
        const customConfirmMessage = document.getElementById('custom-confirm-message');
        const customConfirmYesButton = document.getElementById('custom-confirm-yes-btn');
        const customConfirmNoButton = document.getElementById('custom-confirm-no-btn');
        const closeConfirmModalButton = document.getElementById('close-confirm-modal-btn');

        // --- Utility Functions for Modals ---
        function showAlert(title, message) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';
        }
        customAlertOkButton.addEventListener('click', () => customAlertModal.style.display = 'none');
        closeAlertModalButton.addEventListener('click', () => customAlertModal.style.display = 'none');

        function showConfirm(title, message, callback) {
            customConfirmTitle.textContent = title;
            customConfirmMessage.textContent = message;
            customConfirmModal.style.display = 'flex';
            customConfirmYesButton.onclick = () => {
                customConfirmModal.style.display = 'none';
                callback(true);
            };
            customConfirmNoButton.onclick = () => {
                customConfirmModal.style.display = 'none';
                callback(false);
            };
        }
        closeConfirmModalButton.addEventListener('click', () => customConfirmModal.style.display = 'none');
        cancelEditButton.addEventListener('click', () => closeEditModal());


        // --- Local Storage Functions ---
        function loadSentencesFromStorage() {
            const storedSentences = localStorage.getItem('pronunciationAppSentences');
            if (storedSentences) {
                sentences = JSON.parse(storedSentences);
            }
            if (!sentences || sentences.length === 0) { // Ensure there are always some sentences
                sentences = [...defaultSentences];
                saveSentencesToStorage();
            }
        }

        function saveSentencesToStorage() {
            localStorage.setItem('pronunciationAppSentences', JSON.stringify(sentences));
        }

        // --- Mode Toggling ---
        function toggleMode() {
            if (currentMode === 'student') {
                currentMode = 'teacher';
                toggleModeButton.textContent = 'Switch to Student Mode';
                studentModeContainer.classList.add('hidden');
                teacherModeContainer.classList.remove('hidden');
                renderSentenceList();
            } else {
                currentMode = 'student';
                toggleModeButton.textContent = 'Switch to Teacher Mode';
                studentModeContainer.classList.remove('hidden');
                teacherModeContainer.classList.add('hidden');
                loadSentencesFromStorage(); // Reload sentences for student mode
                currentSentenceIndex = 0; // Reset index
                displaySentence();
            }
        }
        toggleModeButton.addEventListener('click', toggleMode);

        // --- Teacher Mode Functions ---
        function renderSentenceList() {
            sentenceList.innerHTML = '';
            if (sentences.length === 0) {
                noSentencesMessage.classList.remove('hidden');
                return;
            }
            noSentencesMessage.classList.add('hidden');
            sentences.forEach((sentence, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'sentence-list-item';
                const textSpan = document.createElement('span');
                textSpan.className = 'sentence-text';
                textSpan.textContent = sentence.length > 50 ? sentence.substring(0, 50) + '...' : sentence;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'sentence-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => openEditModal(index);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteSentence(index);
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                listItem.appendChild(textSpan);
                listItem.appendChild(actionsDiv);
                sentenceList.appendChild(listItem);
            });
        }

        function addSentence() {
            const text = newSentenceText.value.trim();
            if (text) {
                sentences.push(text);
                saveSentencesToStorage();
                renderSentenceList();
                newSentenceText.value = '';
                showAlert('Success', 'Sentence added successfully.');
            } else {
                showAlert('Input Required', 'Please enter a sentence.');
            }
        }
        addSentenceButton.addEventListener('click', addSentence);

        function deleteSentence(index) {
            const sentenceToDelete = sentences[index].substring(0,30) + (sentences[index].length > 30 ? "..." : "");
            showConfirm('Confirm Deletion', `Are you sure you want to delete "${sentenceToDelete}"?`, (confirmed) => {
                if (confirmed) {
                    sentences.splice(index, 1);
                    saveSentencesToStorage();
                    renderSentenceList();
                    showAlert('Success', 'Sentence deleted successfully.');
                }
            });
        }

        function openEditModal(index) {
            editingSentenceIndex = index;
            editSentenceInput.value = sentences[index];
            editModal.style.display = 'flex';
        }

        function closeEditModal() {
            editModal.style.display = 'none';
            editingSentenceIndex = -1;
        }
        closeEditModalButton.addEventListener('click', closeEditModal);
        // Close modal if clicked outside content
        window.addEventListener('click', (event) => {
            if (event.target == editModal) closeEditModal();
            if (event.target == customAlertModal) customAlertModal.style.display = 'none';
            if (event.target == customConfirmModal) customConfirmModal.style.display = 'none';
        });


        function saveEditedSentence() {
            const newText = editSentenceInput.value.trim();
            if (newText && editingSentenceIndex > -1) {
                sentences[editingSentenceIndex] = newText;
                saveSentencesToStorage();
                renderSentenceList();
                closeEditModal();
                showAlert('Success', 'Sentence updated successfully.');
            } else if (!newText) {
                showAlert('Input Required', 'Please enter a sentence.');
            }
        }
        saveEditButton.addEventListener('click', saveEditedSentence);

        // --- Student Mode (Pronunciation App) Functions ---
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognitionAPI();
            speechRecognition.continuous = false; // Process after user stops speaking for a bit
            speechRecognition.lang = 'en-US';
            speechRecognition.interimResults = false; // Only final results
            speechRecognition.maxAlternatives = 1;

            speechRecognition.onresult = (event) => {
                const recognized = event.results[0][0].transcript;
                recognizedTextDisplay.textContent = recognized;
                comparePronunciation(sentences[currentSentenceIndex], recognized);
            };

            speechRecognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error, event.message);
                let msg = "Speech recognition error.";
                if (event.error === 'no-speech') msg = "No speech was detected.";
                else if (event.error === 'audio-capture') msg = "Microphone access issue.";
                else if (event.error === 'not-allowed') {
                    msg = "Microphone permission denied.";
                    micPermissionGranted = false; // Reset permission status
                } else if (event.error === 'network') msg = "Network error during recognition.";
                else msg = `Unexpected error: ${event.error}`;
                
                statusMessage.textContent = msg;
                if (isRecording) stopAudioAndSpeechRecognition(); // Ensure recording stops on error
            };

            speechRecognition.onstart = () => {
                // UI updates are handled in startAudioAndSpeechRecognition
            };
            
            speechRecognition.onend = () => {
                // This can be triggered by speechRecognition.stop() or automatically.
                // Ensure UI consistency if recording was active.
                if (isRecording) {
                    stopAudioAndSpeechRecognition(); // Handles UI reset if not already done
                }
            };
        } else {
            statusMessage.textContent = "Your browser doesn't support speech recognition.";
            disableStudentButtons();
        }
        
        if ('speechSynthesis' in window) {
            synthesis.onvoiceschanged = () => {
                const voices = synthesis.getVoices();
                englishVoice = voices.find(voice => voice.lang.startsWith('en-') && voice.name.includes('Google US English')) ||
                               voices.find(voice => voice.lang.startsWith('en-') && voice.default) ||
                               voices.find(voice => voice.lang.startsWith('en-'));
                if (!englishVoice) console.warn("English voice not found for TTS.");
                // displaySentence(); // Initial display is handled at the end of script
            };
            if (synthesis.getVoices().length > 0) { // Firefox might load voices immediately
                synthesis.onvoiceschanged();
            }
        } else {
            statusMessage.textContent = "Your browser doesn't support speech synthesis.";
            if(speakButton) speakButton.disabled = true;
            // displaySentence(); // Initial display
        }

        function disableStudentButtons() {
            if(speakButton) speakButton.disabled = true;
            if(recordButton) recordButton.disabled = true;
            if(nextButton) nextButton.disabled = true;
            if(playRecordedAudioButton) playRecordedAudioButton.disabled = true;
        }

        function displaySentence() {
            if (sentences && sentences.length > 0 && currentSentenceIndex < sentences.length) {
                sentenceDisplay.textContent = sentences[currentSentenceIndex];
                nextButton.disabled = sentences.length <= 1;
            } else {
                sentenceDisplay.textContent = "No sentences available. Add some in Teacher Mode.";
                disableStudentButtons();
            }
            recognizedTextDisplay.textContent = "";
            resultFeedback.textContent = "";
            playRecordedAudioButton.disabled = true;
            recordedAudioPlayer.classList.add('hidden');
            recordedAudioPlayer.src = '';
            if (statusMessage) statusMessage.textContent = "Ready";
        }

        function speakSentence() {
            if (!synthesis || !('speak' in synthesis) || !sentences || sentences.length === 0) { 
                statusMessage.textContent = "Speech synthesis not available or no sentence loaded.";
                return;
            }
            if (synthesis.speaking) synthesis.cancel(); // Cancel any ongoing speech

            const utterance = new SpeechSynthesisUtterance(sentences[currentSentenceIndex]);
            if (englishVoice) utterance.voice = englishVoice;
            utterance.lang = 'en-US';
            utterance.pitch = 1;
            utterance.rate = 0.9; 
            
            utterance.onstart = () => {
                statusMessage.textContent = "Speaking example...";
                speakButton.disabled = true;
                recordButton.disabled = true;
                playRecordedAudioButton.disabled = true;
            };
            utterance.onend = () => {
                statusMessage.textContent = "Example finished.";
                speakButton.disabled = false;
                if (micPermissionGranted || speechRecognition) recordButton.disabled = false;
            };
            utterance.onerror = (event) => {
                console.error("Speech synthesis error:", event.error);
                statusMessage.textContent = "Error speaking example.";
                speakButton.disabled = false;
                if (micPermissionGranted || speechRecognition) recordButton.disabled = false;
            };
            synthesis.speak(utterance);
        }
        
        async function handleRecordButtonClick() {
            if (!speechRecognition || !sentences || sentences.length === 0) {
                statusMessage.textContent = "Speech recognition not available or no sentence loaded.";
                return;
            }

            if (isRecording) {
                stopAudioAndSpeechRecognition();
            } else {
                await startAudioAndSpeechRecognition();
            }
        }
        
        async function startAudioAndSpeechRecognition() {
            if (!micPermissionGranted) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micPermissionGranted = true;
                    setupMediaRecorder(stream); // Setup MediaRecorder with the obtained stream
                } catch (err) {
                    console.error("Mic permission error:", err);
                    micPermissionGranted = false;
                    let msg = "Error accessing microphone.";
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') msg = "Microphone permission denied.";
                    else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') msg = "No microphone found.";
                    statusMessage.textContent = msg;
                    return; 
                }
            } else if (!mediaRecorder || mediaRecorder.stream.getAudioTracks().some(track => track.readyState === 'ended')) {
                 // If permission was granted but stream is old/ended, get a new one
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    setupMediaRecorder(stream);
                } catch (err) {
                    statusMessage.textContent = "Failed to re-initialize microphone.";
                    return;
                }
            }


            if (!mediaRecorder) { // If setupMediaRecorder failed
                statusMessage.textContent = "Recording setup failed.";
                return;
            }

            audioChunks = [];
            recordedAudioBlob = null;
            playRecordedAudioButton.disabled = true;
            recordedAudioPlayer.classList.add('hidden');
            recordedAudioPlayer.src = '';
            recognizedTextDisplay.textContent = ""; // Clear previous recognized text
            resultFeedback.textContent = "";      // Clear previous feedback


            try {
                mediaRecorder.start();
                speechRecognition.start(); 
                isRecording = true;
                recordButton.textContent = "Stop Recording";
                recordButton.classList.remove('btn-success');
                recordButton.classList.add('btn-danger');
                statusMessage.textContent = "Recording... Speak into the microphone.";
                speakButton.disabled = true; 
                nextButton.disabled = true; 
            } catch (e) {
                console.error("Error starting recording/recognition:", e);
                statusMessage.textContent = "Failed to start recording.";
                isRecording = false; // Reset state
                recordButton.textContent = "Record Pronunciation";
                recordButton.classList.remove('btn-danger');
                recordButton.classList.add('btn-success');
                speakButton.disabled = false;
                nextButton.disabled = sentences.length <= 1;
            }
        }

        function setupMediaRecorder(stream) {
            try {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    if (audioChunks.length > 0) {
                        recordedAudioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                        const audioUrl = URL.createObjectURL(recordedAudioBlob);
                        recordedAudioPlayer.src = audioUrl;
                        playRecordedAudioButton.disabled = false;
                    } else {
                        playRecordedAudioButton.disabled = true;
                    }
                    // Stop the tracks of the stream MediaRecorder was using
                    if (mediaRecorder && mediaRecorder.stream) {
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    }
                };
                mediaRecorder.onerror = (event) => {
                    console.error("MediaRecorder error:", event.error);
                    statusMessage.textContent = "Error during audio recording.";
                    if (isRecording) stopAudioAndSpeechRecognition();
                };
            } catch (e) {
                console.error("Error setting up MediaRecorder:", e);
                statusMessage.textContent = "MediaRecorder setup failed. Browser might not support it.";
                mediaRecorder = null;
            }
        }

        function stopAudioAndSpeechRecognition() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop(); // This will trigger mediaRecorder.onstop
            }
            if (speechRecognition && isRecording) { // Check isRecording to prevent stopping if not started by this flow
                try {
                    speechRecognition.stop(); 
                } catch (e) {
                    console.warn("Error stopping speech recognition (might be already stopped):", e);
                }
            }
            isRecording = false; // Set this early
            recordButton.textContent = "Record Pronunciation";
            recordButton.classList.remove('btn-danger');
            recordButton.classList.add('btn-success');
            recordButton.disabled = false; 
            statusMessage.textContent = "Recording stopped. Processing..."; // Speech recognition might still be processing
            speakButton.disabled = false; 
            nextButton.disabled = sentences.length <= 1; 
        }
        
        playRecordedAudioButton.addEventListener('click', () => {
            if (recordedAudioPlayer.src && recordedAudioBlob) {
                recordedAudioPlayer.classList.remove('hidden');
                recordedAudioPlayer.play()
                    .catch(e => console.error("Error playing audio:", e));
            } else {
                statusMessage.textContent = "No recorded audio to play.";
            }
        });

        function comparePronunciation(original, recognized) {
            const normalize = (text) => text.toLowerCase().replace(/[.,?!']/g, "").trim();
            const normalizedOriginal = normalize(original);
            const normalizedRecognized = normalize(recognized);

            if (!normalizedOriginal) { // Should not happen if sentences are loaded
                resultFeedback.textContent = "Error: No reference sentence loaded.";
                resultFeedback.className = "feedback-display feedback-incorrect";
                return;
            }
            if (!normalizedRecognized) { // If speech recognition returned empty
                resultFeedback.textContent = "Could not understand your speech. Try again.";
                resultFeedback.className = "feedback-display feedback-incorrect";
                return;
            }


            if (normalizedOriginal === normalizedRecognized) {
                resultFeedback.textContent = "Excellent! That's correct!";
                resultFeedback.className = "feedback-display feedback-correct";
            } else {
                resultFeedback.textContent = "Not quite. Try again!";
                resultFeedback.className = "feedback-display feedback-incorrect";
                // Could add more detailed diff here later
            }
        }

        // Event Listeners for buttons
        if(speakButton) speakButton.addEventListener('click', speakSentence);
        if(recordButton) recordButton.addEventListener('click', handleRecordButtonClick); 

        if(nextButton) {
            nextButton.addEventListener('click', () => {
                if (!sentences || sentences.length === 0) return; 
                if (isRecording) stopAudioAndSpeechRecognition(); // Stop if recording
                if (synthesis && synthesis.speaking) synthesis.cancel(); // Stop if speaking

                currentSentenceIndex = (currentSentenceIndex + 1) % sentences.length;
                displaySentence(); 
                
                // Re-enable buttons that might have been disabled
                speakButton.disabled = false; 
                recordButton.disabled = false; 
            });
        }

        // --- Initial Setup ---
        loadSentencesFromStorage();
        // Initial display of sentence. Voices for TTS might load asynchronously.
        // So, we call displaySentence. If voices are not ready, speakSentence might use a default.
        // If synthesis is available and voices are not yet loaded, onvoiceschanged will handle it.
        // Otherwise, if voices are already loaded or synthesis is not available, display immediately.
        if (synthesis && typeof synthesis.onvoiceschanged !== 'undefined' && synthesis.getVoices().length === 0) {
            // Waiting for voices to load, onvoiceschanged will eventually call displaySentence or it's called after timeout
            // However, it's better to display something initially.
            displaySentence(); // Display with potentially no specific voice yet
        } else {
            displaySentence(); // Display immediately
        }
         // Ensure student mode is active by default if teacher mode was last active and page reloaded
        if (teacherModeContainer.classList.contains('hidden')) {
            currentMode = 'student';
            toggleModeButton.textContent = 'Switch to Teacher Mode';
        } else {
            currentMode = 'teacher';
            toggleModeButton.textContent = 'Switch to Student Mode';
        }

    </script>
</body>
</html>
