<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英単語学習アプリ (間違えた単語確認モード付き)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .word-display {
            font-size: 2.2rem;
            font-weight: bold;
            color: #1E40AF;
            margin-bottom: 0.5rem;
            min-height: 60px;
        }
        .meaning-display {
            font-size: 1.15rem;
            color: #374151;
            min-height: 40px;
            transition: opacity 0.3s ease-in-out;
        }
        .meaning-hidden {
            opacity: 0;
        }
        .btn {
            transition: background-color 0.3s ease;
        }
        .btn:disabled {
            background-color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .custom-checkbox {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.25rem;
            border-color: #60A5FA;
        }
        .custom-checkbox:checked {
            background-color: #3B82F6;
            border-color: #3B82F6;
        }
        .icon-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
        }
        .icon-btn svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            fill: currentColor;
        }
        .edit-btn { color: #2563EB; /* blue-600 */ }
        .edit-btn:hover { color: #1D4ED8; /* blue-700 */ }
        .delete-btn { color: #EF4444; /* red-500 */ }
        .delete-btn:hover { color: #DC2626; /* red-600 */ }

        .mode-section {
            display: none; 
        }
        .mode-section.active {
            display: block; 
        }
        .word-table {
            width: 100%;
            border-collapse: collapse;
        }
        .word-table th, .word-table td {
            border: 1px solid #e5e7eb; 
            padding: 0.75rem; 
            text-align: left;
        }
        .word-table th {
            background-color: #f9fafb; 
        }
        .word-table td .custom-checkbox { margin: auto; display: block; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-100 via-indigo-50 to-purple-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6 sm:mb-8">英単語学習アプリ</h1>

        <div id="loadingIndicator" class="text-center text-gray-500 my-8">
            <p>データを読み込み中...</p>
        </div>

        <div id="mainMenuSection" class="mode-section">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">メインメニュー</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="goToLearningModeButton" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md text-lg">
                    単語を確認する
                </button>
                <button id="goToEditingModeButton" class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md text-lg">
                    単語リストを編集
                </button>
                <button id="goToMistakesReviewModeButton" class="btn bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md text-lg col-span-1 sm:col-span-2 mt-2">
                    間違えた単語を確認
                </button>
            </div>
             <button id="openAddWordModalButtonGlobal" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md w-full text-lg mt-6">
                新しい単語を追加
            </button>
        </div>

        <div id="learningModeSection" class="mode-section">
            <button class="backToMenuButton btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md mb-4 text-sm">← メニューに戻る</button>
            <div id="noWordsMessageLearning" class="text-center text-gray-500 my-8 hidden">
                 <p>まだ単語が登録されていません。「単語リストを編集」または「新しい単語を追加」から単語を追加してください。</p>
            </div>
            <div id="wordCardContainerLearning">
                <div class="card bg-slate-50 p-6 rounded-lg shadow-inner mb-6 relative">
                    <div>
                        <div id="wordDisplayLearning" class="word-display text-center"></div>
                        <div id="meaningDisplayLearning" class="meaning-display meaning-hidden text-center mt-2"></div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex items-center">
                            <input type="checkbox" id="markAsMistakeCheckboxLearning" class="custom-checkbox mr-2 focus:ring-blue-500">
                            <label for="markAsMistakeCheckboxLearning" class="text-sm text-gray-700">間違えた</label>
                        </div>
                        <button id="deleteWordButtonLearning" class="icon-btn delete-btn" title="この単語を削除">
                            <svg viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <button id="showMeaningButtonLearning" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md w-full text-lg">
                        意味を表示
                    </button>
                    <button id="nextWordButtonLearning" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md w-full text-lg">
                        次の単語
                    </button>
                </div>
            </div>
        </div>

        <div id="mistakesReviewModeSection" class="mode-section">
            <button class="backToMenuButton btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md mb-4 text-sm">← メニューに戻る</button>
            <div id="noWordsMessageMistakes" class="text-center text-gray-500 my-8 hidden">
                 <p>間違えた単語はありません。素晴らしい！</p>
            </div>
            <div id="wordCardContainerMistakes">
                <div class="card bg-red-50 p-6 rounded-lg shadow-inner mb-6 relative"> <div>
                        <div id="wordDisplayMistakes" class="word-display text-center text-red-700"></div> <div id="meaningDisplayMistakes" class="meaning-display meaning-hidden text-center mt-2"></div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex items-center">
                            <input type="checkbox" id="markAsMistakeCheckboxMistakes" class="custom-checkbox mr-2 focus:ring-red-500" checked> <label for="markAsMistakeCheckboxMistakes" class="text-sm text-gray-700">間違えた (チェックを外すとリストから除外)</label>
                        </div>
                         <button id="deleteWordButtonMistakes" class="icon-btn delete-btn" title="この単語を完全に削除">
                            <svg viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <button id="showMeaningButtonMistakes" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md w-full text-lg">
                        意味を表示
                    </button>
                    <button id="nextWordButtonMistakes" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md w-full text-lg">
                        次の単語
                    </button>
                </div>
            </div>
        </div>


        <div id="editingModeSection" class="mode-section">
            <button class="backToMenuButton btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md mb-4 text-sm">← メニューに戻る</button>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">登録単語リスト</h2>
             <div id="noWordsMessageEditing" class="text-center text-gray-500 my-8 hidden">
                 <p>まだ単語が登録されていません。「新しい単語を追加」ボタンから最初の単語を追加しましょう！</p>
            </div>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table id="wordListTable" class="word-table">
                    <thead>
                        <tr>
                            <th class="w-1/3">英単語</th>
                            <th class="w-1/3">意味</th>
                            <th class="w-1/12 text-center">間違えた</th>
                            <th class="w-1/6 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="wordListTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-600 mt-6">
            <span id="wordCounter">単語 0 / 0</span>
            <p id="userIdDisplay" class="mt-1 text-xs text-gray-400"></p>
        </div>
    </div>

    <div id="addWordModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">新しい単語を追加</h2>
            <form id="addWordForm">
                <div class="mb-4">
                    <label for="newWordInput" class="block text-sm font-medium text-gray-700 mb-1">英単語</label>
                    <div class="flex gap-2">
                        <input type="text" id="newWordInput" name="newWord" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <button type="button" id="fetchMeaningButton" class="btn bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                            意味を検索
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="newMeaningInput" class="block text-sm font-medium text-gray-700 mb-1">意味（日本語訳など）</label>
                    <textarea id="newMeaningInput" name="newMeaning" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="closeAddWordModalButton" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        キャンセル
                    </button>
                    <button type="submit" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">
                        追加する
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editWordModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">単語を編集</h2>
            <form id="editWordForm">
                <input type="hidden" id="editWordIdInput">
                <div class="mb-4">
                    <label for="editWordTextInput" class="block text-sm font-medium text-gray-700 mb-1">英単語</label>
                    <input type="text" id="editWordTextInput" name="editWordText" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="editMeaningTextInput" class="block text-sm font-medium text-gray-700 mb-1">意味</label>
                    <textarea id="editMeaningTextInput" name="editMeaningText" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="closeEditWordModalButton" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        キャンセル
                    </button>
                    <button type="submit" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">
                        更新する
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let allWords = []; // Firestoreから取得した全単語リスト
        let mistakenWordsList = []; // isMistaken: true の単語リスト
        
        let currentLearningWordIndex = 0;
        let currentMistakeWordIndex = 0;

        let meaningVisibleLearning = false;
        let meaningVisibleMistakes = false;

        let db, auth, userId;
        let isAuthReady = false;
        let wordsUnsubscribe = null;
        let currentMode = 'menu'; // 'menu', 'learning', 'editing', 'mistakesReview'

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // DOM Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainMenuSection = document.getElementById('mainMenuSection');
        const learningModeSection = document.getElementById('learningModeSection');
        const editingModeSection = document.getElementById('editingModeSection');
        const mistakesReviewModeSection = document.getElementById('mistakesReviewModeSection'); // Added
        
        const goToLearningModeButton = document.getElementById('goToLearningModeButton');
        const goToEditingModeButton = document.getElementById('goToEditingModeButton');
        const goToMistakesReviewModeButton = document.getElementById('goToMistakesReviewModeButton'); // Added
        const backToMenuButtons = document.querySelectorAll('.backToMenuButton');

        // Learning Mode Elements (IDs updated for clarity)
        const wordDisplayLearning = document.getElementById('wordDisplayLearning');
        const meaningDisplayLearning = document.getElementById('meaningDisplayLearning');
        const showMeaningButtonLearning = document.getElementById('showMeaningButtonLearning');
        const nextWordButtonLearning = document.getElementById('nextWordButtonLearning');
        const markAsMistakeCheckboxLearning = document.getElementById('markAsMistakeCheckboxLearning');
        const deleteWordButtonLearning = document.getElementById('deleteWordButtonLearning');
        const noWordsMessageLearning = document.getElementById('noWordsMessageLearning');
        const wordCardContainerLearning = document.getElementById('wordCardContainerLearning');

        // Mistakes Review Mode Elements (New)
        const wordDisplayMistakes = document.getElementById('wordDisplayMistakes');
        const meaningDisplayMistakes = document.getElementById('meaningDisplayMistakes');
        const showMeaningButtonMistakes = document.getElementById('showMeaningButtonMistakes');
        const nextWordButtonMistakes = document.getElementById('nextWordButtonMistakes');
        const markAsMistakeCheckboxMistakes = document.getElementById('markAsMistakeCheckboxMistakes');
        const deleteWordButtonMistakes = document.getElementById('deleteWordButtonMistakes');
        const noWordsMessageMistakes = document.getElementById('noWordsMessageMistakes');
        const wordCardContainerMistakes = document.getElementById('wordCardContainerMistakes');


        const wordListTableBody = document.getElementById('wordListTableBody');
        const noWordsMessageEditing = document.getElementById('noWordsMessageEditing');

        const wordCounter = document.getElementById('wordCounter');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        const openAddWordModalButtonGlobal = document.getElementById('openAddWordModalButtonGlobal');
        const addWordModal = document.getElementById('addWordModal');
        const addWordForm = document.getElementById('addWordForm');
        const newWordInput = document.getElementById('newWordInput');
        const newMeaningInput = document.getElementById('newMeaningInput');
        const closeAddWordModalButton = document.getElementById('closeAddWordModalButton');
        const fetchMeaningButton = document.getElementById('fetchMeaningButton'); 

        const editWordModal = document.getElementById('editWordModal');
        const editWordForm = document.getElementById('editWordForm');
        const editWordIdInput = document.getElementById('editWordIdInput');
        const editWordTextInput = document.getElementById('editWordTextInput');
        const editMeaningTextInput = document.getElementById('editMeaningTextInput');
        const closeEditWordModalButton = document.getElementById('closeEditWordModalButton');


        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                loadingIndicator.textContent = "Firebaseの設定がありません。";
                switchMode('menu'); 
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `UserID: ${userId}`;
                        isAuthReady = true;
                        await setupWordListener();
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingIndicator.textContent = "Firebaseの初期化に失敗しました。";
                switchMode('menu');
            }
        }

        function switchMode(mode) {
            currentMode = mode; 

            mainMenuSection.classList.toggle('active', mode === 'menu');
            learningModeSection.classList.toggle('active', mode === 'learning');
            editingModeSection.classList.toggle('active', mode === 'editing');
            mistakesReviewModeSection.classList.toggle('active', mode === 'mistakesReview'); // Added
            
            loadingIndicator.classList.add('hidden');

            if (mode === 'learning') {
                if (allWords.length > 0) {
                    noWordsMessageLearning.classList.add('hidden');
                    wordCardContainerLearning.classList.remove('hidden');
                    displayWordInLearningMode(); 
                } else {
                    noWordsMessageLearning.classList.remove('hidden');
                    wordCardContainerLearning.classList.add('hidden');
                }
            } else if (mode === 'editing') {
                renderWordListForEditing(); 
            } else if (mode === 'mistakesReview') { // Added
                mistakenWordsList = allWords.filter(word => word.isMistaken);
                currentMistakeWordIndex = 0; // Reset index for this mode
                if (mistakenWordsList.length > 0) {
                    noWordsMessageMistakes.classList.add('hidden');
                    wordCardContainerMistakes.classList.remove('hidden');
                    displayWordInMistakesReviewMode();
                } else {
                    noWordsMessageMistakes.classList.remove('hidden');
                    wordCardContainerMistakes.classList.add('hidden');
                }
            }
            updateWordCounter(); 
        }

        async function setupWordListener() {
            if (!isAuthReady || !userId) {
                console.warn("認証が準備できていないため、単語リスナーを設定できません。メニューにフォールバックします。");
                switchMode('menu');
                goToLearningModeButton.disabled = true;
                goToEditingModeButton.disabled = true;
                goToMistakesReviewModeButton.disabled = true;
                openAddWordModalButtonGlobal.disabled = true;
                return;
            }

            goToLearningModeButton.disabled = false;
            goToEditingModeButton.disabled = false;
            goToMistakesReviewModeButton.disabled = false;
            openAddWordModalButtonGlobal.disabled = false;

            if (wordsUnsubscribe) wordsUnsubscribe(); 

            const wordsCollectionPath = `/artifacts/${appId}/users/${userId}/words`;
            const q = query(collection(db, wordsCollectionPath)); 

            wordsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allWords = [];
                querySnapshot.forEach((doc) => {
                    allWords.push({ id: doc.id, ...doc.data() });
                });
                
                // Reset learning index if out of bounds
                if (currentLearningWordIndex >= allWords.length) {
                    currentLearningWordIndex = Math.max(0, allWords.length - 1);
                }

                // Update mistaken words list for mistakes review mode
                mistakenWordsList = allWords.filter(word => word.isMistaken);
                if (currentMistakeWordIndex >= mistakenWordsList.length) {
                     currentMistakeWordIndex = Math.max(0, mistakenWordsList.length -1);
                }


                if (!loadingIndicator.classList.contains('hidden')) { // Initial load
                    switchMode('menu'); 
                } else { // Subsequent updates, refresh current view
                    if (currentMode === 'learning' && learningModeSection.classList.contains('active')) {
                        if (allWords.length > 0) {
                            noWordsMessageLearning.classList.add('hidden');
                            wordCardContainerLearning.classList.remove('hidden');
                            displayWordInLearningMode();
                        } else {
                            noWordsMessageLearning.classList.remove('hidden');
                            wordCardContainerLearning.classList.add('hidden');
                        }
                    } else if (currentMode === 'editing' && editingModeSection.classList.contains('active')) {
                        renderWordListForEditing();
                    } else if (currentMode === 'mistakesReview' && mistakesReviewModeSection.classList.contains('active')) {
                         // Re-filter and display for mistakes review mode
                        mistakenWordsList = allWords.filter(word => word.isMistaken); // Ensure list is fresh
                        if (currentMistakeWordIndex >= mistakenWordsList.length) { // Adjust index if current word was unmarked
                           currentMistakeWordIndex = Math.max(0, mistakenWordsList.length -1);
                        }
                        if (mistakenWordsList.length > 0) {
                            noWordsMessageMistakes.classList.add('hidden');
                            wordCardContainerMistakes.classList.remove('hidden');
                            displayWordInMistakesReviewMode();
                        } else {
                            noWordsMessageMistakes.classList.remove('hidden');
                            wordCardContainerMistakes.classList.add('hidden');
                        }
                    }
                }
                updateWordCounter();

            }, (error) => {
                console.error("単語の購読中にエラーが発生しました: ", error);
                loadingIndicator.textContent = "単語の読み込みに失敗しました。";
                if (currentMode !== 'menu' || !mainMenuSection.classList.contains('active')) {
                     switchMode('menu');
                }
                goToLearningModeButton.disabled = true;
                goToEditingModeButton.disabled = true;
                goToMistakesReviewModeButton.disabled = true;
            });
        }

        async function addWordToFirestore(word, meaning) {
            if (!isAuthReady || !userId) {
                alert("ログイン状態を確認してください。");
                return;
            }
            try {
                const wordsCollectionPath = `/artifacts/${appId}/users/${userId}/words`;
                await addDoc(collection(db, wordsCollectionPath), {
                    word: word,
                    meaning: meaning,
                    isMistaken: false,
                    createdAt: Timestamp.now()
                });
            } catch (error) {
                console.error("Error adding word: ", error);
                alert("単語の追加中にエラーが発生しました。");
            }
        }

        async function updateWordInFirestore(wordId, newWord, newMeaning) {
            if (!isAuthReady || !userId) return;
            try {
                const wordDocRef = doc(db, `/artifacts/${appId}/users/${userId}/words`, wordId);
                await updateDoc(wordDocRef, {
                    word: newWord,
                    meaning: newMeaning
                });
            } catch (error) {
                console.error("Error updating word: ", error);
                alert("単語の更新中にエラーが発生しました。");
            }
        }
        
        async function updateWordMistakeStatus(wordId, isMistaken) {
            if (!isAuthReady || !userId) return;
            try {
                const wordDocRef = doc(db, `/artifacts/${appId}/users/${userId}/words`, wordId);
                await updateDoc(wordDocRef, { isMistaken: isMistaken });
                // onSnapshot will refresh the views
            } catch (error) {
                console.error("Error updating mistake status: ", error);
                alert("「間違えた」状態の更新中にエラーが発生しました。");
            }
        }

        async function deleteWordFromFirestore(wordId) {
            if (!isAuthReady || !userId) return;
            const currentWordObject = allWords.find(w => w.id === wordId);
            const wordText = currentWordObject ? currentWordObject.word : "選択された単語";

            if (window.confirm(`単語 "${wordText}" を本当に削除しますか？`)) {
                try {
                    const wordDocRef = doc(db, `/artifacts/${appId}/users/${userId}/words`, wordId);
                    await deleteDoc(wordDocRef);
                } catch (error) {
                    console.error("Error deleting word: ", error);
                    alert("単語の削除中にエラーが発生しました。");
                }
            }
        }

        // --- Learning Mode Specific Functions ---
        function displayWordInLearningMode() {
            if (allWords.length === 0) {
                wordDisplayLearning.textContent = "";
                meaningDisplayLearning.textContent = "";
                markAsMistakeCheckboxLearning.checked = false;
                noWordsMessageLearning.classList.remove('hidden');
                wordCardContainerLearning.classList.add('hidden');
                return;
            }
            
            noWordsMessageLearning.classList.add('hidden');
            wordCardContainerLearning.classList.remove('hidden');

            const currentWord = allWords[currentLearningWordIndex];
            wordDisplayLearning.textContent = currentWord.word;
            meaningDisplayLearning.textContent = currentWord.meaning;
            markAsMistakeCheckboxLearning.checked = currentWord.isMistaken || false;

            meaningDisplayLearning.classList.toggle('meaning-hidden', !meaningVisibleLearning);
            showMeaningButtonLearning.textContent = meaningVisibleLearning ? "意味を隠す" : "意味を表示";
        }

        function toggleMeaningLearningMode() {
            if (allWords.length === 0) return;
            meaningVisibleLearning = !meaningVisibleLearning;
            displayWordInLearningMode();
        }

        function showNextWordLearningMode() {
            if (allWords.length === 0) return;
            currentLearningWordIndex = (currentLearningWordIndex + 1) % allWords.length;
            meaningVisibleLearning = false;
            displayWordInLearningMode();
        }

        // --- Mistakes Review Mode Specific Functions ---
        function displayWordInMistakesReviewMode() {
            if (mistakenWordsList.length === 0) {
                wordDisplayMistakes.textContent = "";
                meaningDisplayMistakes.textContent = "";
                markAsMistakeCheckboxMistakes.checked = false; // Should be true if a word is shown
                noWordsMessageMistakes.classList.remove('hidden');
                wordCardContainerMistakes.classList.add('hidden');
                return;
            }

            noWordsMessageMistakes.classList.add('hidden');
            wordCardContainerMistakes.classList.remove('hidden');
            
            const currentWord = mistakenWordsList[currentMistakeWordIndex];
            wordDisplayMistakes.textContent = currentWord.word;
            meaningDisplayMistakes.textContent = currentWord.meaning;
            // This checkbox should always be checked if a word is in this list.
            // Unchecking it will trigger an update and onSnapshot will remove it from mistakenWordsList.
            markAsMistakeCheckboxMistakes.checked = currentWord.isMistaken; 

            meaningDisplayMistakes.classList.toggle('meaning-hidden', !meaningVisibleMistakes);
            showMeaningButtonMistakes.textContent = meaningVisibleMistakes ? "意味を隠す" : "意味を表示";
        }

        function toggleMeaningMistakesMode() {
            if (mistakenWordsList.length === 0) return;
            meaningVisibleMistakes = !meaningVisibleMistakes;
            displayWordInMistakesReviewMode();
        }

        function showNextWordMistakesMode() {
            if (mistakenWordsList.length === 0) return;
            currentMistakeWordIndex = (currentMistakeWordIndex + 1) % mistakenWordsList.length;
            meaningVisibleMistakes = false;
            displayWordInMistakesReviewMode();
        }


        function renderWordListForEditing() {
            wordListTableBody.innerHTML = ''; 
            if (allWords.length === 0) {
                noWordsMessageEditing.classList.remove('hidden');
                wordListTableBody.closest('table').classList.add('hidden'); 
                return;
            }
            
            noWordsMessageEditing.classList.add('hidden');
            wordListTableBody.closest('table').classList.remove('hidden');

            allWords.forEach(word => {
                const row = wordListTableBody.insertRow();
                row.insertCell().textContent = word.word;
                row.insertCell().textContent = word.meaning;
                
                const mistakeCell = row.insertCell();
                const mistakeCheckbox = document.createElement('input');
                mistakeCheckbox.type = 'checkbox';
                mistakeCheckbox.checked = word.isMistaken || false;
                mistakeCheckbox.classList.add('custom-checkbox');
                mistakeCheckbox.addEventListener('change', () => updateWordMistakeStatus(word.id, mistakeCheckbox.checked));
                mistakeCell.appendChild(mistakeCheckbox);
                mistakeCell.classList.add('text-center');

                const actionsCell = row.insertCell();
                actionsCell.classList.add('text-center', 'space-x-2');
                
                const editButton = document.createElement('button');
                editButton.innerHTML = `<svg viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM2 18V6c0-1.1.9-2 2-2h4v2H4v10h10v-4h2v4c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2z"></path></svg>`;
                editButton.classList.add('icon-btn', 'edit-btn');
                editButton.title = "編集";
                editButton.addEventListener('click', () => openEditWordModal(word));
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"></path></svg>`;
                deleteButton.classList.add('icon-btn', 'delete-btn');
                deleteButton.title = "削除";
                deleteButton.addEventListener('click', () => deleteWordFromFirestore(word.id));
                actionsCell.appendChild(deleteButton);
            });
        }

        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            modalElement.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 250);
        }

        function openAddWordModal() {
            addWordForm.reset();
            openModal(addWordModal);
            newWordInput.focus();
        }

        function openEditWordModal(word) {
            editWordForm.reset();
            editWordIdInput.value = word.id;
            editWordTextInput.value = word.word;
            editMeaningTextInput.value = word.meaning;
            openModal(editWordModal);
            editWordTextInput.focus();
        }
        
        function updateWordCounter() {
            if (currentMode === 'learning') {
                 wordCounter.textContent = `単語 ${allWords.length > 0 ? currentLearningWordIndex + 1 : 0} / ${allWords.length}`;
            } else if (currentMode === 'mistakesReview') {
                 wordCounter.textContent = `間違えた単語 ${mistakenWordsList.length > 0 ? currentMistakeWordIndex + 1 : 0} / ${mistakenWordsList.length}`;
            } else { // 'menu' or 'editing'
                 wordCounter.textContent = `総単語数: ${allWords.length}`;
            }
        }

        async function fetchMeaningFromGemini(wordToTranslate) {
            const originalButtonText = fetchMeaningButton.textContent;
            fetchMeaningButton.textContent = "検索中...";
            fetchMeaningButton.disabled = true;

            const prompt = `Translate the English word "${wordToTranslate}" into Japanese. Provide only the Japanese meaning. If multiple meanings exist, provide the most common one or a few separated by commas.`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API error:", errorData);
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const translatedText = result.candidates[0].content.parts[0].text;
                    newMeaningInput.value = translatedText.trim();
                } else {
                    console.warn("Gemini API response structure unexpected or content missing:", result);
                    alert("意味の取得に失敗しました。レスポンス形式が不正です。");
                    newMeaningInput.value = ""; 
                }
            } catch (error) {
                console.error("Error fetching meaning from Gemini:", error);
                alert(`意味の取得中にエラーが発生しました: ${error.message}`);
                newMeaningInput.value = ""; 
            } finally {
                fetchMeaningButton.textContent = originalButtonText;
                fetchMeaningButton.disabled = false;
            }
        }


        // --- Event Listeners ---
        goToLearningModeButton.addEventListener('click', () => switchMode('learning'));
        goToEditingModeButton.addEventListener('click', () => switchMode('editing'));
        goToMistakesReviewModeButton.addEventListener('click', () => switchMode('mistakesReview')); // Added
        backToMenuButtons.forEach(btn => btn.addEventListener('click', () => switchMode('menu')));

        // Learning Mode Listeners
        showMeaningButtonLearning.addEventListener('click', toggleMeaningLearningMode);
        nextWordButtonLearning.addEventListener('click', showNextWordLearningMode);
        markAsMistakeCheckboxLearning.addEventListener('change', (event) => {
            if (allWords.length === 0) return;
            updateWordMistakeStatus(allWords[currentLearningWordIndex].id, event.target.checked);
        });
        deleteWordButtonLearning.addEventListener('click', () => {
            if (allWords.length === 0) return;
            deleteWordFromFirestore(allWords[currentLearningWordIndex].id);
        });

        // Mistakes Review Mode Listeners
        showMeaningButtonMistakes.addEventListener('click', toggleMeaningMistakesMode);
        nextWordButtonMistakes.addEventListener('click', showNextWordMistakesMode);
        markAsMistakeCheckboxMistakes.addEventListener('change', (event) => {
            if (mistakenWordsList.length === 0) return;
            // Update the original word in allWords array via its ID
            updateWordMistakeStatus(mistakenWordsList[currentMistakeWordIndex].id, event.target.checked);
        });
        deleteWordButtonMistakes.addEventListener('click', () => {
            if (mistakenWordsList.length === 0) return;
            deleteWordFromFirestore(mistakenWordsList[currentMistakeWordIndex].id);
        });


        openAddWordModalButtonGlobal.addEventListener('click', openAddWordModal);
        closeAddWordModalButton.addEventListener('click', () => closeModal(addWordModal));
        addWordModal.addEventListener('click', (e) => e.target === addWordModal && closeModal(addWordModal));
        addWordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newWord = newWordInput.value.trim();
            const newMeaning = newMeaningInput.value.trim();
            if (newWord && newMeaning) {
                await addWordToFirestore(newWord, newMeaning);
                closeModal(addWordModal);
            } else {
                alert("単語と意味の両方を入力してください。");
            }
        });
        
        fetchMeaningButton.addEventListener('click', () => { 
            const wordToFetch = newWordInput.value.trim();
            if (wordToFetch) {
                fetchMeaningFromGemini(wordToFetch);
            } else {
                alert("意味を検索する英単語を入力してください。");
            }
        });

        closeEditWordModalButton.addEventListener('click', () => closeModal(editWordModal));
        editWordModal.addEventListener('click', (e) => e.target === editWordModal && closeModal(editWordModal));
        editWordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const wordId = editWordIdInput.value;
            const updatedWord = editWordTextInput.value.trim();
            const updatedMeaning = editMeaningTextInput.value.trim();
            if (wordId && updatedWord && updatedMeaning) {
                await updateWordInFirestore(wordId, updatedWord, updatedMeaning);
                closeModal(editWordModal);
            } else {
                alert("単語と意味の両方を入力してください。");
            }
        });

        async function main() {
            mainMenuSection.classList.remove('active');
            learningModeSection.classList.remove('active');
            editingModeSection.classList.remove('active');
            mistakesReviewModeSection.classList.remove('active'); // Added
            loadingIndicator.classList.remove('hidden'); 

            if (firebaseConfig) {
                await initializeFirebase();
            } else {
                loadingIndicator.textContent = "Firebase設定が見つかりません。";
                switchMode('menu'); 
            }
        }

        main();
    </script>
</body>
</html>
