import React, { useState, useEffect } from 'react';

// 道徳の項目データ
const categoriesData = [
  { id: 'A', text: 'A. 主として自分自身に関すること' },
  { id: 'B', text: 'B. 主として人とのかかわりに関すること' },
  { id: 'C', text: 'C. 主として集団や社会との関わりに関すること' },
  { id: 'D', text: 'D. 主として生命や自然、崇高なものとの関わりに関すること' },
];

const subItemsData = [
  { id: 1, text: '善悪の判断、自由と責任', correctCategory: 'A' },
  { id: 2, text: '自律、誠実', correctCategory: 'A' },
  { id: 3, text: '節度、節制', correctCategory: 'A' },
  { id: 4, text: '個性伸長', correctCategory: 'A' },
  { id: 5, text: '希望と勇気、努力と強い意志', correctCategory: 'A' },
  { id: 6, text: '親切、思いやり', correctCategory: 'B' },
  { id: 7, text: '感謝', correctCategory: 'B' },
  { id: 8, text: '礼儀', correctCategory: 'B' },
  { id: 9, text: '友情、信頼', correctCategory: 'B' },
  { id: 10, text: '相互理解、寛容', correctCategory: 'B' },
  { id: 11, text: '規則の尊重', correctCategory: 'C' },
  { id: 12, text: '公正、公平、社会正義', correctCategory: 'C' },
  { id: 13, text: '勤労、公共の精神', correctCategory: 'C' },
  { id: 14, text: '家族愛、家庭生活の充実', correctCategory: 'C' },
  { id: 15, text: 'よりよい学校生活、集団生活の充実', correctCategory: 'C' },
  { id: 16, text: '伝統と文化の尊重、国や郷土を愛する態度', correctCategory: 'C' },
  { id: 17, text: '国際理解、国際親善', correctCategory: 'C' },
  { id: 18, text: '生命の尊重', correctCategory: 'D' },
  { id: 19, text: '自然愛護', correctCategory: 'D' },
  { id: 20, text: '感動、畏敬の念', correctCategory: 'D' },
  { id: 21, text: 'よりよく生きる喜び', correctCategory: 'D' },
];

const App = () => {
  const [selectedItemId, setSelectedItemId] = useState(null); // ID of the currently selected sub-item
  const [items, setItems] = useState([]); // Sub-items (with isMatched status)
  const [message, setMessage] = useState(''); // Message to the user
  const [messageType, setMessageType] = useState('initial'); // Type of message (initial, correct, incorrect)
  const [gameOver, setGameOver] = useState(false); // Game over state
  const [feedbackItemId, setFeedbackItemId] = useState(null); // ID of the item currently showing feedback
  const [feedbackCategoryId, setFeedbackCategoryId] = useState(null); // ID of the category currently showing feedback

  useEffect(() => {
    // On game start or reset, shuffle sub-items and set them
    const shuffledItems = [...subItemsData].sort(() => Math.random() - 0.5)
                                          .map(item => ({ ...item, isMatched: false }));
    setItems(shuffledItems);
    setMessage('項目を選んで、対応するメインカテゴリをクリックしてください。');
    setMessageType('initial');
    setGameOver(false);
    setFeedbackItemId(null);
    setFeedbackCategoryId(null);
  }, []);

  // Handler when a sub-item is selected
  const handleItemSelect = (itemId) => {
    if (gameOver) return; // Cannot operate if game is over

    const clickedItem = items.find(item => item.id === itemId);
    if (clickedItem.isMatched) {
      setMessage('この項目はすでに組み合わせ済みです。');
      setMessageType('initial'); // Reset message type
      setSelectedItemId(null); // Unselect item
      return;
    }

    setSelectedItemId(itemId);
    setMessage(`"${clickedItem.text}" を選択中。対応するメインカテゴリを選んでください。`);
    setMessageType('initial'); // Reset message type
  };

  // Handler when a main category is clicked
  const handleCategoryClick = (categoryId) => {
    if (gameOver || !selectedItemId) {
      setMessage('まず項目を選択してください。');
      setMessageType('initial');
      return;
    }

    const selectedItem = items.find(item => item.id === selectedItemId);

    if (selectedItem.correctCategory === categoryId) {
      // Correct answer
      setMessage('正解です！');
      setMessageType('correct');
      setFeedbackItemId(selectedItemId); // Highlight correct item
      setFeedbackCategoryId(categoryId); // Highlight correct category

      // Delay before removing the item
      setTimeout(() => {
        setItems(prevItems =>
          prevItems.map(item =>
            item.id === selectedItemId ? { ...item, isMatched: true } : item
          )
        );
        setSelectedItemId(null); // Unselect
        setFeedbackItemId(null); // Remove highlight
        setFeedbackCategoryId(null); // Remove highlight

        // Check if all items are matched
        if (items.filter(item => !item.isMatched).length === 1) { // If current item count - 1 becomes 0, clear
          setGameOver(true);
          setMessage('おめでとうございます！すべての項目を組み合わせました！');
          setMessageType('correct');
        } else {
          setMessage('続けて項目を選んでください。');
          setMessageType('initial');
        }
      }, 700); // Disappear after 0.7 seconds
    } else {
      // Incorrect answer
      setMessage('残念！違います。');
      setMessageType('incorrect');
      setFeedbackItemId(selectedItemId); // Highlight incorrect item
      setFeedbackCategoryId(categoryId); // Highlight incorrect category

      // Delay before removing highlight and resetting selection
      setTimeout(() => {
        setSelectedItemId(null); // Unselect
        setFeedbackItemId(null); // Remove highlight
        setFeedbackCategoryId(null); // Remove highlight
        setMessage('もう一度、項目とメインカテゴリを選び直してください。');
        setMessageType('initial');
      }, 700); // Highlight removed after 0.7 seconds
    }
  };

  // Handler to reset the game
  const handleReset = () => {
    const shuffledItems = [...subItemsData].sort(() => Math.random() - 0.5)
                                          .map(item => ({ ...item, isMatched: false }));
    setItems(shuffledItems);
    setSelectedItemId(null);
    setMessage('項目を選んで、対応するメインカテゴリをクリックしてください。');
    setMessageType('initial');
    setGameOver(false);
    setFeedbackItemId(null);
    setFeedbackCategoryId(null);
  };

  // Dynamically change message box styles
  const getMessageBoxClasses = () => {
    let baseClasses = "p-3 rounded-lg shadow-md mb-6 md:mb-8 text-center text-lg font-semibold ";
    if (messageType === 'correct') {
      baseClasses += "bg-green-100 text-green-800 border-2 border-green-400 animate-pulse-once";
    } else if (messageType === 'incorrect') {
      baseClasses += "bg-red-100 text-red-800 border-2 border-red-400 animate-shake";
    } else {
      baseClasses += "bg-blue-50 text-gray-700 border border-blue-200";
    }
    return baseClasses;
  };

  // Group matched items by category
  const groupedMatchedItems = categoriesData.reduce((acc, category) => {
    acc[category.id] = items.filter(item => item.isMatched && item.correctCategory === category.id);
    return acc;
  }, {});

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4 font-inter">
      <style>
        {`
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .animate-pulse-once {
            animation: pulse-once 0.7s ease-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.7s cubic-bezier(.36,.07,.19,.97) both;
        }
        `}
      </style>
      <div className="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-4xl border border-blue-200">
        <h1 className="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-6 drop-shadow-sm">
          道徳項目 組み合わせパズル
        </h1>

        {/* メッセージボックス */}
        <div className={getMessageBoxClasses()}>
          {message}
        </div>

        {gameOver && (
          <div className="text-center mb-6">
            <button
              onClick={handleReset}
              className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
            >
              もう一度プレイ！
            </button>
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          {/* サブ項目選択エリア */}
          <div className="bg-purple-50 border border-purple-200 rounded-lg p-5 shadow-inner">
            <h2 className="text-xl md:text-2xl font-bold text-purple-800 mb-4 text-center">項目を選択</h2>
            <div className="grid grid-cols-1 gap-3">
              {items.filter(item => !item.isMatched).map(item => (
                <button
                  key={item.id}
                  onClick={() => handleItemSelect(item.id)}
                  className={`
                    p-3 rounded-lg shadow-sm text-base text-left
                    ${selectedItemId === item.id
                      ? 'bg-purple-600 text-white ring-4 ring-purple-300 transform scale-105'
                      : feedbackItemId === item.id && messageType === 'incorrect'
                        ? 'bg-red-400 text-white animate-shake' // Red highlight for incorrect
                        : 'bg-purple-300 text-purple-900 hover:bg-purple-400 hover:scale-[1.02]'
                    }
                    ${feedbackItemId === item.id && messageType === 'correct' ? 'bg-green-400 text-white animate-pulse-once' : ''} // Green highlight for correct
                    transform transition-all duration-150 ease-in-out
                    focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50
                  `}
                  disabled={gameOver}
                >
                  ({item.id}) {item.text}
                </button>
              ))}
            </div>
          </div>

          {/* メインカテゴリ表示エリア */}
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-5 shadow-inner">
            <h2 className="text-xl md:text-2xl font-bold text-blue-800 mb-4 text-center">メインカテゴリ</h2>
            <div className="grid grid-cols-2 gap-4">
              {categoriesData.map(category => (
                <button
                  key={category.id}
                  onClick={() => handleCategoryClick(category.id)}
                  className={`
                    p-4 rounded-lg shadow-md text-lg font-semibold
                    ${selectedItemId
                      ? feedbackCategoryId === category.id && messageType === 'incorrect'
                        ? 'bg-red-400 text-white animate-shake' // Red highlight for incorrect
                        : feedbackCategoryId === category.id && messageType === 'correct'
                          ? 'bg-green-400 text-white animate-pulse-once' // Green highlight for correct
                          : 'bg-blue-400 text-white hover:bg-blue-500 hover:scale-105'
                      : 'bg-gray-200 text-gray-600 cursor-not-allowed'
                    }
                    transition-all duration-200 ease-in-out
                    focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50
                  `}
                  disabled={!selectedItemId || gameOver}
                >
                  {category.text}
                </button>
              ))}
            </div>
          </div>
        </div>

        {items.filter(item => item.isMatched).length > 0 && (
          <div className="mt-8 p-4 bg-green-50 border border-green-200 rounded-lg shadow-inner">
            <h3 className="text-lg font-bold text-green-800 mb-3 text-center">組み合わせ済み項目</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"> {/* Added grid for responsive layout */}
              {categoriesData.map(category => (
                groupedMatchedItems[category.id] && groupedMatchedItems[category.id].length > 0 && (
                  <div key={category.id} className="bg-white border border-green-200 rounded-lg shadow-sm p-4">
                    <h4 className="text-md font-bold text-green-700 mb-2">{category.text}</h4>
                    <div className="overflow-x-auto">
                      <table className="min-w-full bg-white rounded-lg overflow-hidden text-sm">
                        <thead className="bg-green-100 text-green-700">
                          <tr>
                            <th className="py-2 px-3 text-left font-semibold uppercase tracking-wider">ID</th>
                            <th className="py-2 px-3 text-left font-semibold uppercase tracking-wider">項目</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                          {groupedMatchedItems[category.id].map(item => (
                            <tr key={item.id} className="hover:bg-green-50">
                              <td className="py-2 px-3 text-gray-700">({item.id})</td>
                              <td className="py-2 px-3 text-gray-700">{item.text}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
